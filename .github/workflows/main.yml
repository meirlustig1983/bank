name: Main CI

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
      - name: Build with Gradle
        run: |
          gradle build --exclude-task test

  tests:
    runs-on: ubuntu-latest
    needs: [ build ]
    steps:
      - uses: actions/checkout@v3
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
      - name: Install Docker Compose
        run: |
          sudo apt-get update && sudo apt-get install -y docker-compose
      - name: Start Docker Compose
        run: |
          docker-compose up -d
      - name: Build with Gradle
        run: |
          gradle test
      - name: Stop Docker Compose
        run: |
          docker-compose down

  docker:
    runs-on: ubuntu-latest
    needs: [ build ]
    steps:
      - uses: actions/checkout@v3
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
      - name: Build with Gradle
        run: |
          gradle build --exclude-task test
      - name: Docker login
        run: |
          docker login -u ${{ secrets.DOCKER_USER_NAME }} -p ${{ secrets.DOCKER_TOKEN }}
      - name: Get Gradle project version
        id: get_version
        run: |
          echo "VERSION=$(sed -nE 's/version=([0-9]+\.[0-9]+\.[0-9]+)/\1/p' gradle.properties)" >> $GITHUB_ENV
      - name: Docker build and tag
        run: |
          docker build -t mlustig/bank-management:${{ env.VERSION }} --build-arg VERSION=${{ env.VERSION }} .
          docker push mlustig/bank-management:${{ env.VERSION }}
          docker tag mlustig/bank-management:${{ env.VERSION }} mlustig/bank-management:latest
          docker push mlustig/bank-management:latest

  version:
    runs-on: ubuntu-latest
    needs: [ docker ]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
      - name: Create Branch
        run: |
          git fetch origin main
          git branch -D version-increment || true
          git checkout -b version-increment --track origin/main
      - name: Increment Version
        run: |
          ./gradlew increaseVersion
      - name: Commit changes
        run: |
          git config --local user.email "meirlustig1983@gmail.com"
          git config --local user.name "GitHub Action"
          git add gradle.properties
          git commit -m "Increment Version"
      - name: Push branch
        uses: ad-m/github-push-action@v0.6.0
        with:
          branch: version-increment
          github_token: ${{ secrets.GITHUB_TOKEN }}
      - name: Create Pull Request
        id: create_pr
        run: |
          gh pr create --base main --head version-increment --title "version-increment" --body "Please review and merge the version increment changes." --assignee meirlustig1983 --label ci/cd
          echo "::set-output name=pr_number::$(gh pr view --json number --jq .number)"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Merge Pull Request
        run: |
          gh pr merge ${{ steps.create_pr.outputs.pr_number }} --auto --delete-branch --squash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}